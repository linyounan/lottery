<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
  <meta charset="UTF-8">
  <title>æœƒå“¡æ¸¬è©¦</title>
  <script type="module">
    // Firebase v9 SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ğŸ”§ ä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBkTmMtBRIDuh-RIAyFVRPn-Accbz97CSo",
      authDomain: "lottery4-0.firebaseapp.com",
      projectId: "lottery4-0",
      storageBucket: "lottery4-0.firebasestorage.app",
      messagingSenderId: "186303296218",
      appId: "1:186303296218:web:1d8eea6f77707bf6c86be3",
      measurementId: "G-7V81NLLZZY"
    };

    // åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ğŸ”‘ åºè™Ÿè¨­å®š
    const serialPlans = {
      "30ian": 30,   // æœˆç¹³
      "90ian": 90,   // å­£ç¹³
      "365ian": 365  // å¹´ç¹³
    };

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.expireAt) {
            const leftDays = Math.ceil((data.expireAt - Date.now()) / (1000 * 60 * 60 * 24));
            document.getElementById("status").innerText = `Hi ${user.email} å‰©é¤˜ ${leftDays} å¤©`;
          } else {
            document.getElementById("status").innerText = `Hi ${user.email}ï¼ˆéæœƒå“¡ï¼‰`;
          }
        }
      } else {
        document.getElementById("status").innerText = "å°šæœªç™»å…¥";
      }
    });

    // è¨»å†Š
    document.getElementById("registerBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", cred.user.uid), { expireAt: 0 });
        alert("è¨»å†ŠæˆåŠŸ");
      } catch (e) {
        alert("è¨»å†Šå¤±æ•—ï¼š" + e.message);
      }
    };

    // ç™»éŒ„
    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        alert("ç™»å…¥æˆåŠŸ");
      } catch (e) {
        alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
      }
    };

    // ç™»å‡º
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      alert("å·²ç™»å‡º");
    };

    // ä½¿ç”¨åºè™Ÿå‡ç´šæœƒå“¡
    document.getElementById("serialBtn").onclick = async () => {
      const code = document.getElementById("serial").value.trim();
      const days = serialPlans[code];
      const user = auth.currentUser;
      if (!user) { alert("è«‹å…ˆç™»å…¥"); return; }
      if (!days) { alert("ç„¡æ•ˆåºè™Ÿ"); return; }

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      let expireAt = Date.now();
      if (snap.exists() && snap.data().expireAt > Date.now()) {
        expireAt = snap.data().expireAt;
      }
      expireAt += days * 24 * 60 * 60 * 1000;

      await updateDoc(userRef, { expireAt });
      alert(`åºè™Ÿå•Ÿç”¨æˆåŠŸï¼Œå·²å»¶é•· ${days} å¤©`);
    };
  </script>
</head>
<body>
  <h2>æœƒå“¡æ¸¬è©¦</h2>
  <p id="status">å°šæœªç™»å…¥</p>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="å¯†ç¢¼"><br>
  <button id="registerBtn">è¨»å†Š</button>
  <button id="loginBtn">ç™»å…¥</button>
  <button id="logoutBtn">ç™»å‡º</button>
  <hr>
  <input id="serial" placeholder="è¼¸å…¥åºè™Ÿ"><br>
  <button id="serialBtn">ä½¿ç”¨åºè™Ÿå‡ç´š</button>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>專業抽獎程式 v6.0</title>
<style>
  :root{
    --accent:#ff7f50;
    --gray:#888;
    --deep:#444;
    --win:#ff6f00; /* 得獎橘色 */
  }
  body{
    font-family:"Comic Sans MS","華康手札體","微軟正黑體",sans-serif;
    margin:0; height:100vh; background:#f0f4f8; display:flex; gap:0;
  }
  /* 左側 */
  .left{
    width:40%; min-width:320px; background:#fff; box-shadow:3px 0 10px rgba(0,0,0,.1);
    padding:16px 20px; box-sizing:border-box; display:flex; flex-direction:column;
  }
  .left-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .left h2{ margin:0; font-size:20px; color:#333; border-bottom:2px solid var(--accent); padding-bottom:8px; }
  #userGreeting{ font-size:13px; color:#444; margin-left:8px; }
  .header-actions{ display:flex; gap:8px; align-items:center; }
  .header-actions button{ padding:6px 10px; font-size:13px; border-radius:6px; border:none; cursor:pointer; }
  .btn-primary{ background:var(--accent); color:#fff; }
  .btn-secondary{ background:#666; color:#fff; }
  .btn-gray{ background:#9e9e9e; color:#fff; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; }
  .btn-start{ background:linear-gradient(45deg,#ff9a3c,#ff6f00); color:#fff; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; }
  .btn-start:hover{ background:linear-gradient(45deg,#ff6f00,#ff9a3c); }

  .left textarea{
    width:95%; height:220px; padding:12px; font-size:16px; border-radius:12px; border:1px solid #ccc;
    resize:none; margin:12px 0; box-shadow: inset 0 0 8px rgba(0,0,0,.05);
  }
  .left input[type="text"], .left input[type="number"], .left input[type="password"], .left input[type="email"]{
    width:48%; padding:8px; margin:5px 1%; font-size:14px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;
  }
  .small-note{ font-size:12px; color:#666; margin-top:6px; }

  /* 右側 */
  .right{
    width:60%; min-width:320px; background:#fdf6e3; display:flex; flex-direction:column; align-items:center; padding-top:24px;
  }
  /* 圓形抽獎框（白色外框、內部灰漸層） */
  #scrollArea{
    width:420px; height:420px; border:8px solid #fff; border-radius:50%;
    display:flex; align-items:center; justify-content:center; margin:8px 0 16px;
    background: radial-gradient(circle at 30% 30%, #ccc, #888); /* 內部灰 */
    box-shadow: inset -5px -5px 15px rgba(0,0,0,.2), inset 5px 5px 15px rgba(255,255,255,.3), 5px 5px 20px rgba(0,0,0,.3);
    text-align:center;
  }
  #currentName{
    display:flex; align-items:center; justify-content:center;
    color:var(--gray);
    font-size:64px;              /* 尚未抽獎較小 */
    font-weight:bold;
    line-height:1;
    word-break:break-word;
    max-width:90%;
  }
  /* 跑馬燈字體（中獎滾動中顯示）放大 2 倍 */
  .rolling{ font-size:240px !important; color:var(--gray) !important; }
  .winner{ font-size:200px !important; color:var(--win) !important; animation:flash 0.6s 3; }
  @keyframes flash{ 0%{opacity:1} 50%{opacity:.3} 100%{opacity:1} }

  #history{
    width:360px; max-height:220px; overflow:auto; background:#fff; padding:10px; border-radius:10px; border:1px solid #ccc;
    box-shadow: inset 0 0 5px rgba(0,0,0,.05);
  }
  #history div{ margin-bottom:6px; font-size:14px; }
  #exportBtn{ margin-top:10px; background:var(--accent); color:#fff; font-weight:bold; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; }

  /* Modal 通用 */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal{ width:720px; max-width:92vw; background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
  .modal h2{ margin:0 0 10px; font-size:18px; }
  .modal .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
  .modal .row button{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
  .modal textarea, .modal input, .modal select{ width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; margin-top:8px; }
  .close{ background:#6c757d; color:#fff; }
  .save{ background:#28a745; color:#fff; }
  .small{ font-size:13px; color:#666; margin-top:6px; }

  /* 手機版調整 */
  @media (max-width: 900px){
    body{ flex-direction:column; height:auto; }
    .left, .right{ width:100%; }
    #scrollArea{ width: 78vw; height: 78vw; } /* 跟著螢幕縮放的圓形 */
    .left input[type="text"], .left input[type="number"], .left input[type="password"], .left input[type="email"]{ width:100%; margin:6px 0; }
    .left textarea{ width:100%; }
    #history{ width:90%; }
    .header-actions{ flex-wrap:wrap; }
  }
</style>
</head>
<body>

<!-- 左側：帳號 / 名單 / 控制 -->
<div class="left">
  <div class="left-header">
    <div style="display:flex; align-items:center; gap:8px;">
      <h2>參加者名單</h2>
      <div id="userGreeting">未登入</div>
    </div>
    <div class="header-actions">
      <button id="btnLogin" class="btn-secondary">登入</button>
      <button id="btnRegister" class="btn-secondary">註冊</button>
      <button id="btnLogout" class="btn-secondary" style="display:none;">登出</button>
      <button id="btnPurchase" class="btn-primary" style="display:none;">購買方案</button>
    </div>
  </div>

  <textarea id="names" placeholder="每行輸入一位參加者"></textarea>
  <input type="text" id="prizeInput" placeholder="本次抽獎獎品，例如：iPad"><br>

  <p>數字範圍生成名單：</p>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <input type="number" id="startNumber" placeholder="起始" value="1">
    <input type="number" id="endNumber" placeholder="結束" value="100">
    <button class="btn-gray" id="btnGenNumbers">生成號碼名單</button>
  </div>

  <p>抽幾個中獎者：</p>
  <input type="number" id="winnerCount" value="1" min="1" style="width:100%; margin-bottom:10px;">

  <button class="btn-start" id="btnStart">開始抽獎</button>

  <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
    <button class="btn-gray" id="btnUpload">上傳CSV</button>
    <button class="btn-gray" id="btnSample">載入範例</button>
    <button class="btn-gray" id="btnClear">清空名單</button>
    <button class="btn-gray" id="btnClearHistory">清除歷史紀錄</button>
    <button class="btn-gray" id="btnOther">其他</button>
  </div>

  <div class="small-note">※ 需是「會員」且通過密碼驗證，才能使用「其他」。</div>
  <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none;">
</div>

<!-- 右側：抽獎圓形 + 紀錄 -->
<div class="right">
  <div id="scrollArea">
    <div id="currentName">尚未抽獎</div>
  </div>
  <div id="history">得獎紀錄會顯示在此。</div>
  <button id="exportBtn">匯出中獎名單</button>
</div>

<!-- 購買方案 (序號) -->
<div id="purchaseModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>購買會員方案</h2>
    <div class="small">請選擇方案，並輸入序號以升級會員（序號不會顯示在頁面上，請從官方取得）。</div>
    <select id="purchasePlan">
      <option value="month">月繳 100 元</option>
      <option value="quarter">季繳 250 元</option>
      <option value="year">年繳 800 元</option>
    </select>
    <input id="serialInput" placeholder="輸入序號" />
    <div class="row">
      <button class="close" id="closePurchase">取消</button>
      <button class="save" id="applySerial">升級會員</button>
    </div>
  </div>
</div>

<!-- 其他（指定名單） -->
<div id="settingsModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>設定：管理指定名單（會員 + 密碼）</h2>
    <div class="small">每行輸入一個「優先抽中」的名字。會儲存在你的帳號資料中。</div>
    <textarea id="specifiedList" placeholder="每行一個名字"></textarea>
    <div class="row">
      <button class="close" id="closeSettings">取消</button>
      <button class="save" id="saveSettings">儲存設定</button>
    </div>
  </div>
</div>

<!-- 登入 -->
<div id="loginModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>登入</h2>
    <input id="logEmail" type="email" placeholder="Email" />
    <input id="logPass" type="password" placeholder="密碼" />
    <div class="row">
      <button class="close" id="closeLogin">取消</button>
      <button class="save" id="doLogin">登入</button>
    </div>
  </div>
</div>

<!-- 註冊 -->
<div id="registerModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>註冊</h2>
    <input id="regEmail" type="email" placeholder="Email" />
    <input id="regPass" type="password" placeholder="密碼" />
    <div class="row">
      <button class="close" id="closeRegister">取消</button>
      <button class="save" id="doRegister">註冊</button>
    </div>
    <div class="small" id="buyHint" style="display:none; margin-top:8px;">註冊完成後可前往「購買方案」輸入序號升級為會員。</div>
  </div>
</div>

<script type="module">
  /* ================= Firebase SDK（使用 CDN ESM） ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  /* ======== 你的 Firebase 設定（已套你提供的專案） ======== */
  const firebaseConfig = {
    apiKey: "AIzaSyBkTmMtBRIDuh-RIAyFVRPn-Accbz97CSo",
    authDomain: "lottery4-0.firebaseapp.com",
    projectId: "lottery4-0",
    storageBucket: "lottery4-0.appspot.com",
    messagingSenderId: "186303296218",
    appId: "1:186303296218:web:1d8eea6f77707bf6c86be3",
    measurementId: "G-7V81NLLZZY"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ================== UI 綁定 ================== */
  const q = sel => document.querySelector(sel);
  const userGreeting = q('#userGreeting');
  const btnLogin = q('#btnLogin'), btnRegister=q('#btnRegister'), btnLogout=q('#btnLogout'), btnPurchase=q('#btnPurchase');

  const loginModal=q('#loginModal'), registerModal=q('#registerModal'), purchaseModal=q('#purchaseModal'), settingsModal=q('#settingsModal');

  // 名單與控制
  const namesTA = q('#names');
  const prizeInput = q('#prizeInput');
  const startNumber = q('#startNumber'), endNumber=q('#endNumber');
  const winnerCount = q('#winnerCount');

  const btnGenNumbers=q('#btnGenNumbers'), btnStart=q('#btnStart'), btnUpload=q('#btnUpload'), btnSample=q('#btnSample'), btnClear=q('#btnClear'), btnClearHistory=q('#btnClearHistory'), btnOther=q('#btnOther');
  const csvFile=q('#csvFile');

  const scrollArea=q('#scrollArea'), currentName=q('#currentName');
  const historyDiv=q('#history'), exportBtn=q('#exportBtn');

  // 購買方案
  const purchasePlan=q('#purchasePlan'), serialInput=q('#serialInput');
  const closePurchase=q('#closePurchase'), applySerial=q('#applySerial');

  // 其他 (指定名單)
  const specifiedListTA=q('#specifiedList'), closeSettings=q('#closeSettings'), saveSettings=q('#saveSettings');

  // 登入 / 註冊 modal 控制
  const doLogin=q('#doLogin'), closeLogin=q('#closeLogin');
  const doRegister=q('#doRegister'), closeRegister=q('#closeRegister');
  const logEmail=q('#logEmail'), logPass=q('#logPass'), regEmail=q('#regEmail'), regPass=q('#regPass');
  const buyHint=q('#buyHint');

  /* =========== 狀態 =========== */
  let winnerLog = []; // {name, prize, time}
  let spinning = false;
  // 「其他」密碼（可以放多組）
  const OTHER_PASSWORDS = ["911021"]; // 想新增就把字串加進陣列

  /* ========== 工具 ========== */
  function showModal(m){ m.style.display='flex'; }
  function hideModal(m){ m.style.display='none'; }
  function toast(msg){ alert(msg); }

  function renderHistory(){
    if(!winnerLog.length){ historyDiv.textContent='得獎紀錄會顯示在此。'; return; }
    historyDiv.innerHTML='';
    winnerLog.forEach(r=>{
      const d=document.createElement('div');
      d.textContent = `${r.name} — ${r.prize? r.prize+' — ' : ''}${new Date(r.time).toLocaleString()}`;
      historyDiv.appendChild(d);
    });
  }
  function updateDisplay(name, state){ // state: 'idle' | 'rolling' | 'win'
    if(state==='idle' || !name){
      currentName.textContent='尚未抽獎';
      currentName.classList.remove('rolling','winner');
      currentName.style.color='var(--gray)';
      currentName.style.fontSize='64px';
      return;
    }
    currentName.textContent = name;
    if(state==='rolling'){
      currentName.classList.add('rolling');
      currentName.classList.remove('winner');
    }else if(state==='win'){
      currentName.classList.remove('rolling');
      currentName.classList.add('winner');
    }
  }

  /* ========== Firebase 資料 ========== */

  async function ensureUserDoc(uid, email){
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, { email, isMember:false, premiumUntil:null, specifiedList:[] });
    }
  }

  async function getUserData(){
    const u = auth.currentUser;
    if(!u) return null;
    const ref=doc(db,"users",u.uid);
    const snap=await getDoc(ref);
    return snap.exists()? snap.data() : null;
  }

  async function saveSpecifiedListToCloud(arr){
    const u = auth.currentUser; if(!u) return;
    const ref=doc(db,"users",u.uid);
    await updateDoc(ref,{ specifiedList: arr });
  }

  async function loadSpecifiedListFromCloud(){
    const data = await getUserData();
    return data && Array.isArray(data.specifiedList) ? data.specifiedList : [];
  }

  /* ========== Auth 流程 ========== */

  btnLogin.onclick = ()=> showModal(loginModal);
  btnRegister.onclick = ()=> showModal(registerModal);
  btnLogout.onclick = async ()=> { await signOut(auth); };

  closeLogin.onclick = ()=> hideModal(loginModal);
  closeRegister.onclick = ()=> hideModal(registerModal);

  doRegister.onclick = async ()=>{
    const email=regEmail.value.trim(), pass=regPass.value;
    if(!email || !pass) return toast('請輸入 Email 與密碼');
    try{
      const {user} = await createUserWithEmailAndPassword(auth, email, pass);
      await ensureUserDoc(user.uid, email);
      hideModal(registerModal);
      toast('註冊完成，請前往購買方案升級會員（輸入序號）');
    }catch(e){ toast('註冊失敗：'+e.message); }
  };

  doLogin.onclick = async ()=>{
    const email=logEmail.value.trim(), pass=logPass.value;
    if(!email || !pass) return toast('請輸入 Email 與密碼');
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      hideModal(loginModal);
      toast('登入成功');
    }catch(e){ toast('登入失敗：'+e.message); }
  };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      const data = await getUserData() || {};
      const remainDays = data.premiumUntil ? Math.max(0, Math.ceil((data.premiumUntil - Date.now()) / (86400*1000))) : null;
      userGreeting.textContent = data.email ? `Hi ${data.email}${remainDays!=null?`（剩餘 ${remainDays} 天）`: '（非會員）'}` : '已登入';
      btnLogout.style.display='inline-block';
      btnLogin.style.display='none';
      btnRegister.style.display='none';
      btnPurchase.style.display = data.isMember ? 'none' : 'inline-block';
      buyHint.style.display='block';
    }else{
      userGreeting.textContent='未登入';
      btnLogout.style.display='none';
      btnLogin.style.display='inline-block';
      btnRegister.style.display='inline-block';
      btnPurchase.style.display='none';
    }
  });

  /* ========== 購買方案（序號驗證） ========== */
  btnPurchase.onclick = ()=> showModal(purchaseModal);
  closePurchase.onclick = ()=> hideModal(purchaseModal);

  applySerial.onclick = async ()=>{
    const user=auth.currentUser; if(!user) return toast('請先登入');
    const plan = purchasePlan.value; // month/quarter/year（目前顯示用）
    const code = serialInput.value.trim();
    if(!code) return toast('請輸入序號');

    // 序號在 Firestore: serials/<code> { days: 30|90|365 }
    const sRef = doc(db,"serials", code);
    const sSnap = await getDoc(sRef);
    if(!sSnap.exists()){ toast('序號錯誤或不存在'); return; }
    const { days } = sSnap.data();

    // 更新會員狀態
    const uRef = doc(db,"users", user.uid);
    const uSnap = await getDoc(uRef);
    let premiumUntil = Date.now();
    if(uSnap.exists() && uSnap.data().premiumUntil){
      premiumUntil = Math.max(premiumUntil, uSnap.data().premiumUntil);
    }
    premiumUntil += days * 86400 * 1000;

    await updateDoc(uRef, { isMember:true, premiumUntil });
    hideModal(purchaseModal);
    serialInput.value='';
    toast(`升級成功！到期：${new Date(premiumUntil).toLocaleDateString()}`);
  };

  /* ========== 「其他」功能（會員 + 密碼） ========== */
  btnOther.onclick = async ()=>{
    const user=auth.currentUser;
    if(!user){ toast('請先登入'); return; }
    const data = await getUserData();
    if(!data || !data.isMember || !data.premiumUntil || data.premiumUntil < Date.now()){
      // 未是會員或過期
      if(confirm('此功能限會員使用。要前往購買方案嗎？')) showModal(purchaseModal);
      return;
    }
    const pw = prompt('請輸入密碼：');
    if(!pw || !OTHER_PASSWORDS.includes(pw)){ toast('密碼錯誤'); return; }

    // 載入雲端指定名單
    const list = await loadSpecifiedListFromCloud();
    specifiedListTA.value = list.join('\n');
    showModal(settingsModal);
  };

  closeSettings.onclick = ()=> hideModal(settingsModal);
  saveSettings.onclick = async ()=>{
    const lines = specifiedListTA.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    await saveSpecifiedListToCloud(lines);
    hideModal(settingsModal);
    toast('已儲存指定名單');
  };

  /* ========== 抽獎邏輯 ========== */
  function addHistoryRecord(name){
    const prize = prizeInput.value.trim() || '';
    const rec = { name, prize, time: new Date().toISOString() };
    winnerLog.unshift(rec);
    renderHistory();
  }

  btnStart.onclick = async ()=>{
    if(spinning) return;
    let pool = namesTA.value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(pool.length===0) return toast('請先輸入名單');

    // 從雲端拿指定名單（只保留出現在 pool 的）
    const specified = (await loadSpecifiedListFromCloud()).filter(x => pool.includes(x));

    const total = Math.max(1, parseInt(winnerCount.value||'1',10));
    spinning = true;

    for(let i=0;i<total;i++){
      if(pool.length===0) break;

      // 跑馬燈（灰色）
      const runMs = 2500 + Math.random()*1500;
      const start = performance.now();
      function roll(now){
        const idx = Math.floor(Math.random()*pool.length);
        updateDisplay(pool[idx], 'rolling');
        if(now - start < runMs) requestAnimationFrame(roll);
        else{
          // 決定中獎者：若有指定名單優先，否則隨機
          let winner;
          const selectableSpecified = specified.filter(x => pool.includes(x));
          if(selectableSpecified.length>0){
            const r = Math.floor(Math.random()*selectableSpecified.length);
            winner = selectableSpecified[r];
            // 用過就從指定名單陣列移除，避免連續命中同一人
            selectableSpecified.splice(r,1);
          }else{
            winner = pool[Math.floor(Math.random()*pool.length)];
          }

          // 顯示橘色中獎、記錄、從池中移除避免重複
          updateDisplay(winner, 'win');
          addHistoryRecord(winner);
          pool = pool.filter(n => n !== winner);
          namesTA.value = pool.join('\n');

          // 下一位前小停
          setTimeout(()=> stepResolve(), 800);
        }
      }
      let stepResolve;
      await new Promise(res => { stepResolve = res; requestAnimationFrame(roll); });
    }

    spinning = false;
  };

  /* ========== 其他功能 ========== */
  btnGenNumbers.onclick = ()=>{
    const s = parseInt(startNumber.value,10), e = parseInt(endNumber.value,10);
    if(isNaN(s)||isNaN(e)||s>e) return toast('請輸入正確的數字範圍');
    const arr=[]; for(let i=s;i<=e;i++) arr.push(String(i));
    namesTA.value = arr.join('\n');
    updateDisplay('', 'idle');
  };

  btnUpload.onclick = ()=> csvFile.click();
  csvFile.addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      const lines = ev.target.result.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
      const list = lines.map(r=> r.split(',')[0].replace(/^"|"$/g,'').trim()).filter(Boolean);
      namesTA.value = list.join('\n');
      updateDisplay('', 'idle');
    };
    reader.readAsText(f,'UTF-8');
    csvFile.value='';
  });

  btnSample.onclick = ()=>{
    namesTA.value = '張三\n李四\n王五\n小明\n小美';
    updateDisplay('', 'idle');
  };

  btnClear.onclick = ()=>{ namesTA.value=''; updateDisplay('', 'idle'); };

  btnClearHistory.onclick = ()=>{ winnerLog=[]; renderHistory(); };

  exportBtn.onclick = ()=>{
    if(!winnerLog.length) return toast('沒有中獎紀錄');
    const rows = [['名字','獎品','時間']].concat(winnerLog.map(r=>[r.name, r.prize, r.time]));
    const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='winners.csv';
    a.click();
  };

  /* ========== 初始化 ========== */
  function init(){
    updateDisplay('', 'idle');
    renderHistory();

    // 點 backdrop 關閉
    document.querySelectorAll('.modal-backdrop').forEach(m=>{
      m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none'; });
    });
  }
  init();
</script>
</body>
</html>
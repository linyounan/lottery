<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
  <meta charset="UTF-8">
  <title>會員測試</title>
  <script type="module">
    // Firebase v9 SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // 🔧 你的 Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyBkTmMtBRIDuh-RIAyFVRPn-Accbz97CSo",
      authDomain: "lottery4-0.firebaseapp.com",
      projectId: "lottery4-0",
      storageBucket: "lottery4-0.firebasestorage.app",
      messagingSenderId: "186303296218",
      appId: "1:186303296218:web:1d8eea6f77707bf6c86be3",
      measurementId: "G-7V81NLLZZY"
    };

    // 初始化
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 🔑 序號設定
    const serialPlans = {
      "30ian": 30,   // 月繳
      "90ian": 90,   // 季繳
      "365ian": 365  // 年繳
    };

    // 監聽登入狀態
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.expireAt) {
            const leftDays = Math.ceil((data.expireAt - Date.now()) / (1000 * 60 * 60 * 24));
            document.getElementById("status").innerText = `Hi ${user.email} 剩餘 ${leftDays} 天`;
          } else {
            document.getElementById("status").innerText = `Hi ${user.email}（非會員）`;
          }
        }
      } else {
        document.getElementById("status").innerText = "尚未登入";
      }
    });

    // 註冊
    document.getElementById("registerBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", cred.user.uid), { expireAt: 0 });
        alert("註冊成功");
      } catch (e) {
        alert("註冊失敗：" + e.message);
      }
    };

    // 登錄
    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        alert("登入成功");
      } catch (e) {
        alert("登入失敗：" + e.message);
      }
    };

    // 登出
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      alert("已登出");
    };

    // 使用序號升級會員
    document.getElementById("serialBtn").onclick = async () => {
      const code = document.getElementById("serial").value.trim();
      const days = serialPlans[code];
      const user = auth.currentUser;
      if (!user) { alert("請先登入"); return; }
      if (!days) { alert("無效序號"); return; }

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      let expireAt = Date.now();
      if (snap.exists() && snap.data().expireAt > Date.now()) {
        expireAt = snap.data().expireAt;
      }
      expireAt += days * 24 * 60 * 60 * 1000;

      await updateDoc(userRef, { expireAt });
      alert(`序號啟用成功，已延長 ${days} 天`);
    };
  </script>
</head>
<body>
  <h2>會員測試</h2>
  <p id="status">尚未登入</p>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="密碼"><br>
  <button id="registerBtn">註冊</button>
  <button id="loginBtn">登入</button>
  <button id="logoutBtn">登出</button>
  <hr>
  <input id="serial" placeholder="輸入序號"><br>
  <button id="serialBtn">使用序號升級</button>
</body>
</html>
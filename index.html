<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>專業抽獎程式 v4.0（Firebase + 會員序號 + 指定號碼 + 手機版）</title>
<style>
  body{
    font-family:"Comic Sans MS","華康手札體","微軟正黑體",sans-serif;
    display:flex; margin:0; height:100vh; background:#f0f4f8;
  }
  /* 左側 */
  .left{
    width:40%; min-width:320px; padding:20px; box-sizing:border-box; background:#fff;
    box-shadow:3px 0 10px rgba(0,0,0,.1); display:flex; flex-direction:column;
  }
  .left-header{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
  .left h2{ margin:0; color:#333; border-bottom:2px solid #ff7f50; padding-bottom:8px; font-size:20px; }
  .header-actions{ display:flex; gap:8px; align-items:center; margin-left:12px; }
  .header-actions button{ padding:6px 10px; font-size:13px; border-radius:6px; cursor:pointer; border:none; }
  .btn-primary{ background:#ff7f50; color:#fff; }
  .btn-secondary{ background:#666; color:#fff; }
  #userGreeting{ font-size:13px; color:#444; margin-left:12px; }
  .left textarea{ width:95%; height:220px; padding:12px; font-size:16px; border-radius:12px; border:1px solid #ccc; resize:none; margin-bottom:15px; box-shadow:inset 0 0 8px rgba(0,0,0,.05);}
  .left input[type="text"], .left input[type="number"]{ width:48%; padding:8px; margin:5px 1%; font-size:14px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;}
  .left button{ padding:10px 15px; margin:5px 0; border:none; cursor:pointer; border-radius:8px; font-size:14px; font-weight:bold; transition:.2s; }
  .btn-start{ background:linear-gradient(45deg,#ff9a3c,#ff6f00); color:#fff; }
  .btn-start:hover{ background:linear-gradient(45deg,#ff6f00,#ff9a3c); }
  .btn-gray{ background:#9e9e9e; color:#fff; }
  .btn-gray:hover{ background:#757575; }
  .small-note{ font-size:12px; color:#666; margin-top:8px; }

  /* 右側 */
  .right{
    width:60%; display:flex; align-items:center; justify-content:flex-start; background:#fdf6e3;
    flex-direction:column; position:relative; padding-top:40px;
  }
  /* 跑馬燈圓形框 */
  #scrollArea{
    width:clamp(260px, 60vw, 440px);
    height:clamp(260px, 60vw, 440px);
    border:10px solid #fff;               /* 白色外框 */
    display:flex; align-items:center; justify-content:center;
    font-weight:bold; margin-bottom:20px; position:relative; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #ccc, #888);
    text-align:center;
    box-shadow: inset -5px -5px 15px rgba(0,0,0,.2),
                inset 5px 5px 15px rgba(255,255,255,.3),
                5px 5px 20px rgba(0,0,0,.3);
  }
  /* 尚未抽獎（小一點） */
  #currentName{
    display:flex; align-items:center; justify-content:center;
    color:#888; font-size:64px;   /* 這裡改尚未抽獎字體大小 */
    line-height:1; word-break:break-word;
    max-width:90%;
  }
  /* 滾動中（橘色）時使用的字級（「原本 2 倍」） */
  .rolling{
    color:#ff6f00 !important;
    font-size: calc(min(24vw, 320px));   /* 自適應放大到很大 */
  }
  /* 中獎閃紅 */
  @keyframes flashRed{ 0%{color:red;} 50%{color:black;} 100%{color:red;} }

  #history{
    width:min(420px, 90%); max-height:220px; overflow-y:auto; margin-top:10px; background:#fff;
    padding:10px; border-radius:10px; border:1px solid #ccc; box-shadow: inset 0 0 5px rgba(0,0,0,.05);
    font-size:14px;
  }
  #history div{ margin-bottom:6px; }
  #exportBtn{ margin-top:10px; background:#ff7f50; color:#fff; font-weight:bold; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; }

  /* Modal 共用 */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal{ width:720px; max-width:92vw; background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
  .modal h2{ margin:0 0 10px 0; font-size:18px; }
  .modal textarea, .modal input, .modal select{ width:100%; padding:10px; box-sizing:border-box; border-radius:6px; border:1px solid #ddd; resize:vertical; margin-top:8px; font-size:14px; }
  .modal .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  .modal .row button{ padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; }
  .modal .row .save{ background:#28a745; color:#fff; }
  .modal .row .close{ background:#6c757d; color:#fff; }
  .modal .small{ font-size:13px; color:#666; margin-top:6px; }

  /* 響應式（手機） */
  @media (max-width:900px){
    body{ flex-direction:column; height:auto; }
    .left, .right{ width:100%; box-shadow:none; }
    .left{ border-bottom:8px solid #f2f2f2; }
    #scrollArea{ margin-top:8px; }
  }
</style>
</head>
<body>

<!-- 左側 -->
<div class="left">
  <div class="left-header">
    <div style="display:flex; align-items:center;">
      <h2>參加者名單</h2>
      <div id="userGreeting">尚未登入</div>
    </div>
    <div class="header-actions">
      <button id="loginBtnInline" class="btn-secondary">登入</button>
      <button id="registerBtnInline" class="btn-secondary">註冊</button>
      <button id="logoutBtnInline" class="btn-secondary" style="display:none;">登出</button>
      <button id="purchaseBtn" class="btn-primary" style="display:none;">購買方案</button>
    </div>
  </div>

  <textarea id="names" placeholder="每行輸入一位參加者"></textarea>
  <input type="text" id="prizeInput" placeholder="本次抽獎獎品，例如：iPad"><br>

  <p>數字範圍生成名單：</p>
  起始:<input type="number" id="startNumber" value="1">
  結束:<input type="number" id="endNumber" value="100">
  <button class="btn-gray" id="btnGenNumbers">生成號碼名單</button>

  <p>抽幾個中獎者：</p>
  <input type="number" id="winnerCount" value="1" min="1" style="width:100%; margin-bottom:10px;">

  <button class="btn-start" id="btnStart">開始抽獎</button>

  <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
    <button class="btn-gray" id="btnUploadCSV">上傳CSV</button>
    <button class="btn-gray" id="btnSample">載入範例</button>
    <button class="btn-gray" id="btnClearList">清空名單</button>
    <button class="btn-gray" id="btnClearHistory">清除歷史紀錄</button>
    <button class="btn-gray" id="btnOther">其他</button>
  </div>

  <div class="small-note">※ 登入 + 付費會員 + 密碼保護 才能使用「其他」。密碼預設：911021（可擴充多組）。</div>
</div>

<!-- 右側 -->
<div class="right">
  <div id="scrollArea">
    <div id="currentName">尚未抽獎</div>
  </div>
  <div id="history">得獎紀錄會顯示在此。</div>
  <button id="exportBtn">匯出中獎名單</button>
</div>

<!-- 隱藏 file input -->
<input type="file" id="csvFile" accept=".csv,text/csv" style="display:none;" />

<!-- ========== Modals ========== -->

<!-- Login -->
<div id="loginModal" class="modal-backdrop">
  <div class="modal">
    <h2>登入</h2>
    <div class="small">請輸入 Email 與密碼（Firebase 驗證）。</div>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPass" type="password" placeholder="密碼" />
    <div class="row">
      <button class="close" id="closeLogin">取消</button>
      <button class="save" id="doLogin">登入</button>
    </div>
  </div>
</div>

<!-- Register -->
<div id="registerModal" class="modal-backdrop">
  <div class="modal">
    <h2>註冊</h2>
    <div class="small">請輸入 Email 與密碼（建立 Firebase 帳號）。</div>
    <input id="registerEmail" type="email" placeholder="Email" />
    <input id="registerPass" type="password" placeholder="密碼（至少 6 碼）" />
    <div class="row">
      <button class="close" id="closeRegister">取消</button>
      <button class="save" id="doRegister">註冊</button>
    </div>
  </div>
</div>

<!-- Purchase / Serial -->
<div id="purchaseModal" class="modal-backdrop">
  <div class="modal">
    <h2>購買方案（序號啟用）</h2>
    <p class="small">請選擇方案並輸入序號以啟用會員。價格：月 100 / 季 250 / 年 800。</p>
    <select id="purchasePlan">
      <option value="month">月繳 100 元</option>
      <option value="quarter">季繳 250 元</option>
      <option value="year">年繳 800 元</option>
    </select>
    <input id="serialInput" placeholder="輸入序號（例如 30ian / 90ian / 365ian）" />
    <div class="row">
      <button class="close" id="closePurchase">取消</button>
      <button class="save" id="applySerial">升級會員</button>
    </div>
    <div class="small">注意事項：序號限用一次、會綁定帳號並於不同裝置同步剩餘天數；到期自動失效。</div>
  </div>
</div>

<!-- Settings（其他） -->
<div id="settingsModal" class="modal-backdrop">
  <div class="modal">
    <h2>設定：管理指定名單（付費 + 密碼）</h2>
    <div class="small">每行一個要優先抽中的名字（會保存在本帳號 Firestore，可多裝置同步）。</div>
    <textarea id="specifiedList" placeholder="每行一個名字"></textarea>
    <div class="row">
      <button class="close" id="closeSettings">取消</button>
      <button class="save" id="saveSettings">儲存設定</button>
    </div>
  </div>
</div>

<!-- Firebase SDK（使用 CDN 模組化 v9+） -->
<script type="module">
  /***********************
   * Firebase 初始化
   ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, Timestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  // ！！用你的專案設定（你之前提供的 config）
  const firebaseConfig = {
    apiKey: "AIzaSyBkTmMtBRIDuh-RIAyFVRPn-Accbz97CSo",
    authDomain: "lottery4-0.firebaseapp.com",
    projectId: "lottery4-0",
    storageBucket: "lottery4-0.firebasestorage.app",
    messagingSenderId: "186303296218",
    appId: "1:186303296218:web:1d8eea6f77707bf6c86be3",
    measurementId: "G-7V81NLLZZY"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /***********************
   * UI 綁定
   ***********************/
  const loginBtnInline = document.getElementById('loginBtnInline');
  const registerBtnInline = document.getElementById('registerBtnInline');
  const logoutBtnInline = document.getElementById('logoutBtnInline');
  const purchaseBtn = document.getElementById('purchaseBtn');
  const userGreeting = document.getElementById('userGreeting');

  const loginModal = document.getElementById('loginModal');
  const registerModal = document.getElementById('registerModal');
  const purchaseModal = document.getElementById('purchaseModal');
  const settingsModal = document.getElementById('settingsModal');

  const doLogin = document.getElementById('doLogin');
  const closeLogin = document.getElementById('closeLogin');
  const doRegister = document.getElementById('doRegister');
  const closeRegister = document.getElementById('closeRegister');
  const closePurchase = document.getElementById('closePurchase');
  const applySerialBtn = document.getElementById('applySerial');

  const btnStart = document.getElementById('btnStart');
  const btnGenNumbers = document.getElementById('btnGenNumbers');
  const btnUploadCSV = document.getElementById('btnUploadCSV');
  const btnSample = document.getElementById('btnSample');
  const btnClearList = document.getElementById('btnClearList');
  const btnClearHistory = document.getElementById('btnClearHistory');
  const btnOther = document.getElementById('btnOther');
  const exportBtn = document.getElementById('exportBtn');

  const scrollArea = document.getElementById('scrollArea');
  const currentNameDiv = document.getElementById('currentName');
  const namesTA = document.getElementById('names');
  const prizeInput = document.getElementById('prizeInput');
  const historyDiv = document.getElementById('history');
  const csvFileInput = document.getElementById('csvFile');
  const startNumber = document.getElementById('startNumber');
  const endNumber = document.getElementById('endNumber');
  const winnerCount = document.getElementById('winnerCount');

  const specifiedListTA = document.getElementById('specifiedList');
  const saveSettingsBtn = document.getElementById('saveSettings');
  const closeSettingsBtn = document.getElementById('closeSettings');

  const purchasePlan = document.getElementById('purchasePlan');
  const serialInput = document.getElementById('serialInput');

  /***********************
   * 全域狀態
   ***********************/
  let spinning = false;
  let winnerLog = [];  // {name, prize, time}
  const OTHER_PASSWORDS = ['911021']; // 可擴充多組
  // 後端序號格式：collection "serials" 中的 document：
  // { code: "30ian", days:30, used: false, usedBy: null, usedAt: Timestamp }

  // 使用者檔（users/{uid}）：
  // { memberUntil: Timestamp|null, specified: string[] }

  /***********************
   * 工具：計算剩餘天數字串
   ***********************/
  function daysLeftText(memberUntilTs){
    if(!memberUntilTs) return '（非會員）';
    const now = Date.now();
    const until = memberUntilTs.toMillis ? memberUntilTs.toMillis() : (memberUntilTs.seconds ? memberUntilTs.seconds*1000 : memberUntilTs);
    const diff = until - now;
    if(diff <= 0) return '（會員已到期）';
    const days = Math.ceil(diff / (1000*60*60*24));
    return `（會員 剩餘 ${days} 天）`;
  }

  /***********************
   * Auth 狀態
   ***********************/
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      userGreeting.textContent = '尚未登入';
      loginBtnInline.style.display = 'inline-block';
      registerBtnInline.style.display = 'inline-block';
      logoutBtnInline.style.display = 'none';
      purchaseBtn.style.display = 'none';
      return;
    }
    // 有登入：讀取或建立使用者文件
    const uref = doc(db, 'users', user.uid);
    let usnap = await getDoc(uref);
    if(!usnap.exists()){
      await setDoc(uref, { memberUntil: null, specified: [] }, { merge:true });
      usnap = await getDoc(uref);
    }
    const udata = usnap.data();
    const dl = daysLeftText(udata.memberUntil || null);
    userGreeting.textContent = `Hi ${user.email} ${dl}`;

    // 非會員時顯示購買方案按鈕
    const isMember = (udata.memberUntil && (udata.memberUntil.toMillis ? udata.memberUntil.toMillis() : udata.memberUntil.seconds*1000) > Date.now());
    purchaseBtn.style.display = isMember ? 'none' : 'inline-block';

    loginBtnInline.style.display = 'none';
    registerBtnInline.style.display = 'none';
    logoutBtnInline.style.display = 'inline-block';
  });

  /***********************
   * 登入 / 註冊 / 登出
   ***********************/
  function openModal(m){ m.style.display='flex'; }
  function closeModal(m){ m.style.display='none'; }
  [loginModal, registerModal, purchaseModal, settingsModal].forEach(m=>{
    m.addEventListener('click', (e)=>{ if(e.target===m) closeModal(m); });
  });

  loginBtnInline.onclick = ()=> openModal(loginModal);
  registerBtnInline.onclick = ()=> openModal(registerModal);
  purchaseBtn.onclick = ()=> openModal(purchaseModal);

  closeLogin.onclick = ()=> closeModal(loginModal);
  closeRegister.onclick = ()=> closeModal(registerModal);
  closePurchase.onclick = ()=> closeModal(purchaseModal);

  doLogin.onclick = async ()=>{
    const email = (document.getElementById('loginEmail').value || '').trim();
    const pass  = (document.getElementById('loginPass').value  || '');
    if(!email || !pass){ alert('請輸入 Email 與密碼'); return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      closeModal(loginModal);
      alert('登入成功');
    }catch(err){
      console.error(err);
      alert('登入失敗：' + err.message);
    }
  };

  doRegister.onclick = async ()=>{
    const email = (document.getElementById('registerEmail').value || '').trim();
    const pass  = (document.getElementById('registerPass').value  || '');
    if(!email || !pass){ alert('請輸入 Email 與密碼'); return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      closeModal(registerModal);
      alert('註冊完成並已登入');
    }catch(err){
      console.error(err);
      alert('註冊失敗：' + err.message);
    }
  };

  logoutBtnInline.onclick = async ()=>{
    await signOut(auth);
    alert('已登出');
  };

  /***********************
   * 會員：序號啟用（同步到 Firestore）
   ***********************/
  applySerialBtn.onclick = async ()=>{
    const plan = purchasePlan.value; // month/quarter/year（僅UI）
    const code = (serialInput.value || '').trim();
    if(!code){ alert('請輸入序號'); return; }
    const user = auth.currentUser;
    if(!user){ alert('請先登入'); return; }

    // 先到 Firestore 查序號
    // 可用資料表：serials（文件ID 隨意，欄位：code, days, used, usedBy, usedAt）
    // 允許多組同 code，用 query 查找第一個尚未使用的
    try{
      const q = query(collection(db,'serials'), where('code','==', code), where('used','==', false));
      const snap = await getDocs(q);
      let docToUse = null;
      let days = 0;
      if(!snap.empty){
        docToUse = snap.docs[0];
        days = docToUse.data().days || 0;
      }else{
        // 若後端尚未建 serials，提供本地 fallback（30ian/90ian/365ian）
        const localMap = { '30ian':30, '90ian':90, '365ian':365 };
        if(!(code in localMap)){ alert('序號無效或已被使用'); return; }
        days = localMap[code];
      }

      // 更新使用者 memberUntil
      const uref = doc(db,'users',user.uid);
      const usnap = await getDoc(uref);
      const nowMs = Date.now();
      let base = nowMs;
      if(usnap.exists() && usnap.data().memberUntil){
        const cur = usnap.data().memberUntil.toMillis ? usnap.data().memberUntil.toMillis() : usnap.data().memberUntil.seconds*1000;
        base = Math.max(base, cur);
      }
      const added = days*24*60*60*1000;
      const newUntil = new Date(base + added);

      await setDoc(uref, { memberUntil: Timestamp.fromDate(newUntil) }, { merge:true });

      // 標記序號已使用（如果是雲端的）
      if(docToUse){
        await updateDoc(doc(db,'serials',docToUse.id), {
          used: true,
          usedBy: user.uid,
          usedAt: serverTimestamp()
        });
      }

      serialInput.value = '';
      closeModal(purchaseModal);
      alert(`會員啟用成功！已延長 ${days} 天。`);
      // 觸發 UI 更新：onAuthStateChanged 會自動跑；也可重新讀取 user doc（等下一個 render）
      const refreshed = await getDoc(uref);
      const dl = daysLeftText(refreshed.data().memberUntil);
      userGreeting.textContent = `Hi ${user.email} ${dl}`;
      // 隱藏購買按鈕（若仍有剩餘天數）
      const isMember = (refreshed.data().memberUntil.toMillis() > Date.now());
      purchaseBtn.style.display = isMember ? 'none' : 'inline-block';

    }catch(err){
      console.error(err);
      alert('序號啟用失敗：' + err.message);
    }
  };

  /***********************
   * 其他（指定號碼）— 需要：已登入 + 會員有效 + 密碼
   ***********************/
  btnOther.onclick = async ()=>{
    const user = auth.currentUser;
    if(!user){ alert('需登入'); return; }
    // 檢查會員
    const uref = doc(db,'users',user.uid);
    const usnap = await getDoc(uref);
    if(!usnap.exists() || !usnap.data().memberUntil || usnap.data().memberUntil.toMillis() <= Date.now()){
      if(confirm('此功能為付費功能，是否前往購買方案？')){
        openModal(purchaseModal);
      }
      return;
    }
    // 密碼保護
    const pw = prompt('請輸入密碼（預設：911021）：');
    if(!pw || !OTHER_PASSWORDS.includes(pw)){ alert('密碼錯誤'); return; }

    // 載入指定清單（雲端同步）
    const specified = (usnap.data().specified || []);
    specifiedListTA.value = specified.join('\n');
    openModal(settingsModal);
  };

  saveSettingsBtn.onclick = async ()=>{
    const user = auth.currentUser;
    if(!user){ alert('需登入'); return; }
    const arr = specifiedListTA.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    try{
      await setDoc(doc(db,'users',user.uid), { specified: arr }, { merge:true });
      alert('指定名單已儲存（雲端）');
      closeModal(settingsModal);
    }catch(err){
      console.error(err); alert('儲存失敗：' + err.message);
    }
  };
  closeSettingsBtn.onclick = ()=> closeModal(settingsModal);

  /***********************
   * 抽獎核心（跑馬燈）
   ***********************/
  function resetDisplay(){
    currentNameDiv.textContent = '尚未抽獎';
    currentNameDiv.classList.remove('rolling');
    currentNameDiv.style.animation = '';
    currentNameDiv.style.color = '#888';
    currentNameDiv.style.fontSize = '64px';
  }
  resetDisplay();

  function updateDuringRoll(name){
    currentNameDiv.textContent = name;
    currentNameDiv.classList.add('rolling'); // 橘色 + 大字
    currentNameDiv.style.animation = '';
  }
  function showWinner(name){
    currentNameDiv.classList.remove('rolling');
    currentNameDiv.textContent = name;
    currentNameDiv.style.color = '#000';
    currentNameDiv.style.animation = 'flashRed .6s 3';
    currentNameDiv.style.fontSize = 'calc(min(22vw, 240px))';
  }

  function addHistoryRecord(name){
    const prize = (prizeInput.value || '').trim();
    const record = { name, prize, time: new Date().toISOString() };
    winnerLog.unshift(record);
    renderHistory();
  }
  function renderHistory(){
    historyDiv.innerHTML = '';
    if(winnerLog.length === 0){
      historyDiv.textContent = '得獎紀錄會顯示在此。';
      return;
    }
    for(const r of winnerLog){
      const d = document.createElement('div');
      d.textContent = `${r.name} — ${r.prize ? r.prize + ' — ' : ''}${new Date(r.time).toLocaleString()}`;
      historyDiv.appendChild(d);
    }
  }
  function clearHistory(){ winnerLog = []; renderHistory(); }

  async function startDraw(){
    if(spinning) return;
    let list = namesTA.value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(list.length===0){ alert('請輸入參加者名單'); return; }
    const count = Math.max(1, parseInt(winnerCount.value||'1',10));
    spinning = true;

    // 讀取雲端指定名單（只做為優先池）
    let specifiedInCloud = [];
    const user = auth.currentUser;
    if(user){
      try{
        const usnap = await getDoc(doc(db,'users',user.uid));
        specifiedInCloud = (usnap.exists() && Array.isArray(usnap.data().specified)) ? usnap.data().specified : [];
      }catch(_){}
    }

    for(let i=0;i<count;i++){
      if(list.length===0) break;
      // 跑馬燈
      let interval = 50, slow=1.05;
      const totalTime = 2600 + Math.random()*1200;
      const startAt = Date.now();
      await new Promise(resolve=>{
        (function roll(){
          const idx = Math.floor(Math.random()*list.length);
          updateDuringRoll(list[idx]);
          interval *= slow;
          if(Date.now() - startAt < totalTime) setTimeout(roll, interval);
          else{
            // 決定得主：若指定名單與現有名單有交集，從交集中挑；否則從整體挑
            const pool = specifiedInCloud.filter(x=>list.includes(x));
            const winner = (pool.length>0 ? pool[Math.floor(Math.random()*pool.length)] : list[Math.floor(Math.random()*list.length)]);
            // 移除，避免重複中
            list = list.filter(n=> n!==winner);
            namesTA.value = list.join('\n');
            addHistoryRecord(winner);
            showWinner(winner);
            resolve();
          }
        })();
      });
      // 每抽一個休息一下
      await new Promise(r=>setTimeout(r, 800));
    }
    spinning = false;
  }

  function generateNumberList(){
    const s = parseInt(startNumber.value, 10);
    const e = parseInt(endNumber.value, 10);
    if(!(Number.isFinite(s) && Number.isFinite(e) && s<=e)){ alert('請輸入正確的數字範圍'); return; }
    const arr=[]; for(let i=s;i<=e;i++) arr.push(String(i));
    namesTA.value = arr.join('\n'); resetDisplay();
  }
  function uploadCSV(){ csvFileInput.click(); }
  csvFileInput.addEventListener('change',(e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const lines = (ev.target.result || '').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      // 取第一欄為名稱
      const parsed = lines.map(row => row.split(',')[0].replace(/^"|"$/g,'').trim()).filter(Boolean);
      namesTA.value = parsed.join('\n'); resetDisplay();
    };
    reader.readAsText(f, 'UTF-8');
    e.target.value = '';
  });
  function loadSample(){
    namesTA.value = '張三\n李四\n王五\n小明\n小美\n小華\n小熊\n小綠';
    resetDisplay();
  }
  function clearList(){ namesTA.value=''; resetDisplay(); }

  function exportWinners(){
    if(winnerLog.length===0){ alert('沒有中獎紀錄可匯出'); return; }
    const rows = [['名字','獎品','時間']];
    winnerLog.forEach(r=> rows.push([r.name, r.prize, r.time]));
    const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'winners.csv';
    a.click();
  }

  /***********************
   * 事件綁定
   ***********************/
  btnStart.onclick = startDraw;
  btnGenNumbers.onclick = generateNumberList;
  btnUploadCSV.onclick = uploadCSV;
  btnSample.onclick = loadSample;
  btnClearList.onclick = clearList;
  btnClearHistory.onclick = ()=> clearHistory();
  exportBtn.onclick = exportWinners;

  // 初始化
  renderHistory();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å°ˆæ¥­æŠ½çç¨‹å¼</title>
<style>
body {
  font-family: "Comic Sans MS","è¯åº·æ‰‹æœ­é«”","å¾®è»Ÿæ­£é»‘é«”",sans-serif;
  display: flex;
  margin: 0;
  height: 100vh;
  background: #f0f4f8;
}
/* å·¦å´åŠŸèƒ½å€ */
.left {
  width: 40%;
  padding: 20px;
  box-sizing: border-box;
  background: #ffffff;
  box-shadow: 3px 0 10px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
}
.left h2 { margin-top: 0; color: #403f3f; border-bottom: 2px solid #ff7f50; padding-bottom: 5px; }
.left textarea { width: 95%; height: 220px; padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid #ccc; resize: none; margin-bottom: 15px; box-shadow: inset 0 0 8px rgba(0,0,0,0.05);}
.left input[type="text"], .left input[type="number"] { width: 48%; padding: 8px; margin: 5px 1%; font-size: 14px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
.left button { padding: 10px 15px; margin: 5px 0; border: none; cursor: pointer; border-radius: 8px; font-size: 14px; font-weight: bold; transition: all 0.2s;}
.left button.btn-start { background: linear-gradient(45deg, #ff9a3c, #ff6f00); color: white;}
.left button.btn-start:hover { background: linear-gradient(45deg, #ff6f00, #ff9a3c); }
.left button.btn-gray { background: #9e9e9e; color: white; }
.left button.btn-gray:hover { background: #757575; }

/* å³å´é¡¯ç¤ºå€ */
.right {
  width: 60%;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  background: #fdf6e3;
  flex-direction: column;
  position: relative;
  padding-top: 60px;
}
#scrollArea {
  width: 420px;
  height: 420px;
  border: 8px solid #ffffff; /* æ·±ç°å¤–åœˆ */
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1200%;
  font-weight: bold;
  margin-bottom: 20px;
  position: relative;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ccc, #888);
  font-family: "Comic Sans MS","è¯åº·æ‰‹æœ­é«”","å¾®è»Ÿæ­£é»‘é«”",sans-serif;
  text-align: center;
  box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2),
              inset 5px 5px 15px rgba(255,255,255,0.3),
              5px 5px 20px rgba(0,0,0,0.3);
}
#currentName { display: flex; align-items: center; justify-content: center; color: #888; font-size: 80px; }
#history {
  width: 360px;
  max-height: 200px;
  overflow-y: scroll;
  margin-top: 10px;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
}
#history div { margin-bottom: 5px; }
#exportBtn { margin-top: 10px; background:#ff7f50; color:white; font-weight:bold; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; }
@keyframes flashRed { 0%{ color: red; } 50%{ color: black; } 100%{ color: red; } }

/* settings modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:2000; }
.modal{ width:720px; max-width:92vw; background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
.modal h2{ margin:0 0 10px 0; font-size:18px; }
.modal textarea{ width:100%; height:180px; padding:8px; box-sizing:border-box; border-radius:6px; border:1px solid #ddd; resize:vertical; }
.modal .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
.modal .row button{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.modal .row .save{ background:#28a745; color:#fff; }
.modal .row .close{ background:#6c757d; color:#fff; }
</style>
</head>
<body>

<div class="left">
  <h2>åƒåŠ è€…åå–®</h2>
  <textarea id="names" placeholder="æ¯è¡Œè¼¸å…¥ä¸€ä½åƒåŠ è€…"></textarea>
  <input type="text" id="prizeInput" placeholder="æœ¬æ¬¡æŠ½ççå“ï¼Œä¾‹å¦‚ï¼šiPad"><br>
  
  <p>æ•¸å­—ç¯„åœç”Ÿæˆåå–®ï¼š</p>
  èµ·å§‹: <input type="number" id="startNumber" value="1">
  çµæŸ: <input type="number" id="endNumber" value="100">
  <button class="btn-gray" onclick="generateNumberList()">ç”Ÿæˆè™Ÿç¢¼åå–®</button>
  
  <p>æŠ½å¹¾å€‹ä¸­çè€…ï¼š</p>
  <input type="number" id="winnerCount" value="1" min="1" style="width: 100%; margin-bottom:10px;">

  <button class="btn-start" onclick="startDraw()">é–‹å§‹æŠ½ç</button>
  
  <div style="display:flex; flex-wrap: wrap; gap:8px; margin-top:10px;">
    <button class="btn-gray" onclick="uploadCSV()">ä¸Šå‚³CSV</button>
    <button class="btn-gray" onclick="loadSample()">è¼‰å…¥ç¯„ä¾‹</button>
    <button class="btn-gray" onclick="clearList()">æ¸…ç©ºåå–®</button>
    <button class="btn-gray" onclick="clearHistory()">æ¸…é™¤æ­·å²ç´€éŒ„</button>
    <button class="btn-gray" onclick="enterPassword()">å…¶ä»–</button>
  </div>
</div>

<div class="right">
  <div id="scrollArea">
    <div id="currentName">å°šæœªæŠ½ç</div>
  </div>
  <div id="history"></div>
  <button id="exportBtn" onclick="exportWinners()">åŒ¯å‡ºä¸­çåå–®</button>
</div>

<input type="file" id="csvFile" accept=".csv,text/csv" style="display:none;">

<!-- Settings modal (hidden by default) -->
<div id="settingsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal" role="document">
    <h2 id="settingsTitle">è¨­å®šï¼šç®¡ç†æŒ‡å®šåå–®ï¼ˆå¯†ç¢¼ä¿è­·ï¼‰</h2>
    <p class="small">åœ¨ä¸‹æ–¹æ¯è¡Œè¼¸å…¥ä¸€å€‹è¦å„ªå…ˆæŠ½ä¸­çš„åå­—ã€‚å„²å­˜å¾Œæœƒå­˜åˆ°æœ¬æ©Ÿç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</p>
    <textarea id="specifiedList" placeholder="æ¯è¡Œä¸€å€‹åå­—ï¼ˆå„²å­˜å¾Œæœƒä¿ç•™ï¼‰"></textarea>
    <div class="row">
      <button class="close" onclick="closeSettingsModal()">å–æ¶ˆ</button>
      <button class="save" onclick="saveSpecifiedList()">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>

<script>
let spinning = false;

// æ›´æ–°é¡¯ç¤º
function updateDisplay(name, color){
  const display = document.getElementById("currentName");
  if(!name){
    display.textContent = "å°šæœªæŠ½ç";
    display.style.fontSize="80px"; display.style.color="#888"; display.style.animation="";
    return;
  }
  display.textContent = name;
  display.style.fontSize="200px";
  if(color){ display.style.color=color; display.style.animation="flashRed 0.6s 3"; }
  else{ display.style.color="#000"; display.style.animation=""; }
}

// æ–°å¢æ­·å²
function addHistory(winner){
  const historyDiv = document.getElementById("history");
  const prize = document.getElementById("prizeInput").value.trim() || "";
  const now = new Date();
  const timeString = now.toLocaleTimeString();
  const entry = document.createElement("div");
  entry.textContent = prize ? `ğŸ‰ ${winner} ä¸­çï¼çå“ï¼š${prize} (${timeString})` : `ğŸ‰ ${winner} ä¸­çï¼ (${timeString})`;
  historyDiv.prepend(entry);
}

// æ¸…ç©ºæ­·å²
function clearHistory(){ document.getElementById("history").innerHTML=""; }

// é–‹å§‹æŠ½çï¼ˆé€ä¸€æŠ½ï¼‰
async function startDraw(){
  if(spinning) return;
  let names = document.getElementById("names").value.trim().split("\n").map(s=>s.trim()).filter(n=>n);
  if(names.length===0){ alert("è«‹è¼¸å…¥åƒåŠ è€…åå–®ï¼"); return; }
  const winnerNum = parseInt(document.getElementById("winnerCount").value) || 1;
  spinning=true;

  for(let i=0;i<winnerNum;i++){
    if(names.length===0) break;
    let displayNames = names.slice();
    let intervalTime = 50, slowDown=1.05;
    const totalTime = 3000 + Math.random()*2000;
    const startTime = Date.now();

    await new Promise(resolve=>{
      function roll(){
        const currentIndex=Math.floor(Math.random()*displayNames.length);
        updateDisplay(displayNames[currentIndex]);
        intervalTime*=slowDown;
        if(Date.now()-startTime<totalTime){ setTimeout(roll, intervalTime); }
        else{
          // å–å‡ºæŒ‡å®šåå–®ï¼ˆlocalStorageï¼‰
          let specified = JSON.parse(localStorage.getItem("specifiedList")||"[]");
          // åªä¿ç•™ä»åœ¨ names ä¸­çš„æŒ‡å®šè€…
          specified = specified.filter(x=>names.includes(x));
          let winner;
          if(specified.length>0){
            winner = specified[Math.floor(Math.random()*specified.length)];
          } else {
            winner = names[Math.floor(Math.random()*names.length)];
          }
          // å°‡ä¸­çè€…åŠ å…¥ winnersã€å¾ä¸»åå–®ç§»é™¤ï¼ˆé¿å…é‡è¤‡ä¸­çï¼‰
          names = names.filter(n=>n!==winner);
          document.getElementById("names").value = names.join("\n");
          // è‹¥å‘½ä¸­æŒ‡å®šè€…ï¼Œå°‡å…¶ä¹Ÿå¾ localStorage çš„æŒ‡å®šåå–®ç§»é™¤ï¼ˆè¦–éœ€æ±‚ä¿ç•™æˆ–ç§»é™¤ï¼‰
          let stored = JSON.parse(localStorage.getItem("specifiedList")||"[]");
          if(stored.includes(winner)){
            stored = stored.filter(n=>n!==winner);
            localStorage.setItem("specifiedList", JSON.stringify(stored));
          }
          addHistory(winner);
          updateDisplay(winner, "red");
          resolve();
        }
      }
      roll();
    });

    // æ¯æŠ½å®Œä¸€ä½åœ 1 ç§’å†æŠ½ä¸‹ä¸€ä½
    await new Promise(r=>setTimeout(r, 1000));
  }

  spinning=false;
}

// CSV ä¸Šå‚³
function uploadCSV(){
  document.getElementById("csvFile").click();
}
document.getElementById("csvFile").addEventListener("change",function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    // è®€ CSV æ¯è¡Œç¬¬ä¸€æ¬„ç‚ºåå­—
    const lines = ev.target.result.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="");
    const parsed = lines.map(l => {
      // æ”¯æ´æœ‰é€—è™Ÿçš„ CSV è¡Œï¼šå–ç¬¬ä¸€æ¬„ï¼ˆè‹¥æ˜¯ CSV å¸¶å¼•è™Ÿä¹Ÿå¯ï¼‰
      const cols = l.split(",");
      return cols[0].replace(/^"|"$/g,'').trim();
    }).filter(x=>x);
    document.getElementById("names").value = parsed.join("\n");
  };
  reader.readAsText(file);
});

// è¼‰å…¥ç¯„ä¾‹
function loadSample(){ document.getElementById("names").value="å¼µä¸‰\næå››\nç‹äº”\nå°æ˜\nå°ç¾"; updateDisplay(""); }

// æ¸…ç©ºåå–®
function clearList(){ document.getElementById("names").value=""; updateDisplay(""); }

// ç”Ÿæˆæ•¸å­—åå–®
function generateNumberList(){
  const start=parseInt(document.getElementById("startNumber").value);
  const end=parseInt(document.getElementById("endNumber").value);
  if(isNaN(start)||isNaN(end)||start>end){ alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸å­—ç¯„åœï¼"); return; }
  const numbers=[];
  for(let i=start;i<=end;i++){ numbers.push(i.toString()); }
  document.getElementById("names").value=numbers.join("\n");
  updateDisplay("");
}

// åŒ¯å‡ºä¸­çåå–®ï¼ˆç°¡æ˜“ CSVï¼‰
function exportWinners(){
  const history = document.getElementById("history");
  if(history.children.length===0){ alert("æ²’æœ‰ä¸­çç´€éŒ„å¯åŒ¯å‡º"); return; }
  let csvContent = "ä¸­çç´€éŒ„\n";
  Array.from(history.children).forEach(div=>{ csvContent += div.textContent.replace(/\n/g,' ') + "\n"; });
  const blob = new Blob([csvContent],{type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "winners.csv";
  a.click();
}

/* ===== å¯†ç¢¼ & Settings Modal ===== */
function enterPassword(){
  const pw = prompt("è«‹è¼¸å…¥å¯†ç¢¼ï¼š");
  if(pw === "911021"){
    // é¡¯ç¤º modal ä¸¦è¼‰å…¥ç¾æœ‰æŒ‡å®šåå–®
    openSettingsModal();
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤ï¼");
  }
}

function openSettingsModal(){
  const modal = document.getElementById("settingsModal");
  const textarea = document.getElementById("specifiedList");
  const stored = JSON.parse(localStorage.getItem("specifiedList")||"[]");
  textarea.value = stored.join("\n");
  modal.style.display = "flex";
  // focus
  setTimeout(()=> textarea.focus(), 100);
}

function closeSettingsModal(){
  const modal = document.getElementById("settingsModal");
  modal.style.display = "none";
}

function saveSpecifiedList(){
  const textarea = document.getElementById("specifiedList");
  const list = textarea.value.split(/\r?\n/).map(s=>s.trim()).filter(s=>s);
  localStorage.setItem("specifiedList", JSON.stringify(list));
  alert("å·²å„²å­˜æŒ‡å®šåå–®ï¼ˆlocalStorageï¼‰");
  closeSettingsModal();
}

/* åˆå§‹åŒ–ï¼šè‹¥ localStorage æœ‰æŒ‡å®šåå–®å¯è¼‰å…¥ï¼ˆéå¿…è¦ï¼‰ */
(function init(){
  // å¦‚æœä¹‹å‰æ²’æœ‰æŠ½çï¼Œä¿æŒå°šæœªæŠ½çæç¤º
  updateDisplay("");
})();
</script>

</body>
</html>
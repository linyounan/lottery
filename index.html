<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>專業抽獎程式 v2.3</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body {
  font-family: "Comic Sans MS","華康手札體","微軟正黑體",sans-serif;
  display: flex;
  margin: 0;
  height: 100vh;
  background: #f0f4f8;
}
/* 左側功能區 */
.left {
  width: 40%;
  padding: 20px;
  box-sizing: border-box;
  background: #ffffff;
  box-shadow: 3px 0 10px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
}
.left-header{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
.left h2 { margin:0; color: #333; border-bottom: 2px solid #ff7f50; padding-bottom: 8px; font-size:20px; }
.header-actions{ display:flex; gap:8px; align-items:center; margin-left:12px; }
.header-actions button{ padding:6px 10px; font-size:13px; border-radius:6px; cursor:pointer; border:none; }
.header-actions .btn-primary{ background:#ff7f50; color:#fff; }
.header-actions .btn-secondary{ background:#666; color:#fff; }
.left textarea { width: 95%; height: 220px; padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid #ccc; resize: none; margin-bottom: 15px; box-shadow: inset 0 0 8px rgba(0,0,0,0.05);}
.left input[type="text"], .left input[type="number"] { width: 48%; padding: 8px; margin: 5px 1%; font-size: 14px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
.left button { padding: 10px 15px; margin: 5px 0; border: none; cursor: pointer; border-radius: 8px; font-size: 14px; font-weight: bold; transition: all 0.2s;}
.left button.btn-start { background: linear-gradient(45deg, #ff9a3c, #ff6f00); color: white;}
.left button.btn-start:hover { background: linear-gradient(45deg, #ff6f00, #ff9a3c); }
.left button.btn-gray { background: #9e9e9e; color: white; }
.left button.btn-gray:hover { background: #757575; }

/* user status small */
#userGreeting{ font-size:13px; color:#444; margin-left:12px; }

/* 右側顯示區 */
.right {
  width: 60%;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  background: #fdf6e3;
  flex-direction: column;
  position: relative;
  padding-top: 60px;
}
#scrollArea {
  width: 420px;
  height: 420px;
  border: 8px solid #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1200%;
  font-weight: bold;
  margin-bottom: 20px;
  position: relative;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ccc, #888);
  font-family: "Comic Sans MS","華康手札體","微軟正黑體",sans-serif;
  text-align: center;
  box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2),
              inset 5px 5px 15px rgba(255,255,255,0.3),
              5px 5px 20px rgba(0,0,0,0.3);
}
#currentName { display: flex; align-items: center; justify-content: center; color: #888; font-size: 80px; }
#history {
  width: 360px;
  max-height: 200px;
  overflow-y: scroll;
  margin-top: 10px;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
}
#history div { margin-bottom: 5px; }
#exportBtn { margin-top: 10px; background:#ff7f50; color:white; font-weight:bold; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; }

/* modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:2000; }
.modal{ width:720px; max-width:92vw; background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
.modal h2{ margin:0 0 10px 0; font-size:18px; }
.modal textarea, .modal input, .modal select{ width:100%; padding:8px; box-sizing:border-box; border-radius:6px; border:1px solid #ddd; resize:vertical; margin-top:8px; }
.modal .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
.modal .row button{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.modal .row .save{ background:#28a745; color:#fff; }
.modal .row .close{ background:#6c757d; color:#fff; }
.modal .small{ font-size:13px; color:#666; margin-top:6px; }

/* small note */
.small-note{ font-size:12px; color:#666; margin-top:8px; }
</style>
</head>
<body>

<div class="left">
  <div class="left-header">
    <div style="display:flex; align-items:center;">
      <h2>參加者名單</h2>
      <div id="userGreeting">尚未登入</div>
    </div>
    <div class="header-actions">
      <button id="loginBtnInline" class="btn-secondary" onclick="openLoginModal()">登入</button>
      <button id="registerBtnInline" class="btn-secondary" onclick="openRegisterModal()">註冊</button>
      <button id="logoutBtnInline" class="btn-secondary" style="display:none;" onclick="logout()">登出</button>
      <button id="purchaseBtn" class="btn-primary" style="display:none;" onclick="openPurchaseModal()">購買方案</button>
    </div>
  </div>

  <textarea id="names" placeholder="每行輸入一位參加者"></textarea>
  <input type="text" id="prizeInput" placeholder="本次抽獎獎品，例如：iPad"><br>
  
  <p>數字範圍生成名單：</p>
  起始: <input type="number" id="startNumber" value="1">
  結束: <input type="number" id="endNumber" value="100">
  <button class="btn-gray" onclick="generateNumberList()">生成號碼名單</button>
  
  <p>抽幾個中獎者：</p>
  <input type="number" id="winnerCount" value="1" min="1" style="width: 100%; margin-bottom:10px;">

  <button class="btn-start" onclick="startDraw()">開始抽獎</button>
  
  <div style="display:flex; flex-wrap: wrap; gap:8px; margin-top:10px;">
    <button class="btn-gray" onclick="uploadCSV()">上傳CSV</button>
    <button class="btn-gray" onclick="loadSample()">載入範例</button>
    <button class="btn-gray" onclick="clearList()">清空名單</button>
    <button class="btn-gray" onclick="clearHistory()">清除歷史紀錄</button>
    <button class="btn-gray" onclick="handleOther()">其他</button>
  </div>

  <div class="small-note">※ 會員（輸入正確序號後）可使用「其他」功能。</div>
</div>

<div class="right">
  <div id="scrollArea">
    <div id="currentName">尚未抽獎</div>
  </div>
  <div id="history"></div>
  <button id="exportBtn" onclick="exportWinners()">匯出中獎名單</button>
</div>

<input type="file" id="csvFile" accept=".csv,text/csv" style="display:none;">

<!-- Settings modal (會員功能) -->
<div id="settingsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal" role="document">
    <h2 id="settingsTitle">設定：管理指定名單（會員功能）</h2>
    <p class="small">在下方每行輸入一個要優先抽中的名字。儲存後會存到本機瀏覽器（localStorage）。</p>
    <textarea id="specifiedList" placeholder="每行一個名字（儲存後會保留）"></textarea>
    <div class="row">
      <button class="close" onclick="closeSettingsModal()">取消</button>
      <button class="save" onclick="saveSpecifiedList()">儲存設定</button>
    </div>
  </div>
</div>

<!-- 購買方案 + 序號驗證 -->
<div id="purchaseModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h2>購買方案</h2>
    <p class="small">選擇方案並輸入序號以升級為【會員】後即可使用「其他」功能。</p>
    <select id="purchasePlan">
      <option value="month">月繳 100 元（30 天）</option>
      <option value="quarter">季繳 250 元（90 天）</option>
      <option value="year">年繳 800 元（365 天）</option>
    </select>
    <input id="serialInput" placeholder="輸入序號" />
    <div class="row">
      <button class="close" onclick="closePurchaseModal()">取消</button>
      <button class="save" onclick="applySerial()">升級為會員</button>
    </div>
    <div class="small-note">
      完成付款後，請向客服索取序號<br>
      付款請務必透過官方指定管道付款，避免受騙<br>
      序號請妥善保管，不向他人透露<br>
      會員資格僅限本人使用，無法轉讓或退費
    </div>
  </div>
</div>

<!-- Login modal -->
<div id="loginModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h2>登入</h2>
    <div class="small">請輸入帳號與密碼。</div>
    <input id="loginUser" placeholder="帳號（username）" />
    <input id="loginPass" type="password" placeholder="密碼" />
    <div class="row">
      <button class="close" onclick="closeLoginModal()">取消</button>
      <button class="save" onclick="login()">登入</button>
    </div>
    <div class="small-note">尚未註冊？請按左上方「註冊」。</div>
  </div>
</div>

<!-- Register modal -->
<div id="registerModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h2>註冊帳號</h2>
    <div class="small">註冊完成後即可登入；登入後可按「購買方案」輸入序號升級為會員。</div>
    <input id="registerUser" placeholder="帳號（username）" />
    <input id="registerPass" type="password" placeholder="密碼" />
    <div class="row" style="justify-content:flex-end;">
      <button class="close" onclick="closeRegisterModal()">取消</button>
      <button class="save" onclick="register()">註冊</button>
    </div>
  </div>
</div>

<script>
/* ================== Auth / Member（client-side demo） ================== */
/*
 localStorage keys:
  - users : JSON array [ {username, passwordHash, memberUntil: number(ms) } ]
  - currentUser : username string
  - specifiedList : JSON array of names（會員設定）
*/

async function sha256Hex(str){
  if(window.crypto && crypto.subtle){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  } else { return 'plain:' + str; }
}
function loadUsers(){ try{ return JSON.parse(localStorage.getItem('users')||'[]'); }catch(e){ return []; } }
function saveUsers(arr){ localStorage.setItem('users', JSON.stringify(arr)); }
function getCurrentUser(){ return localStorage.getItem('currentUser') || null; }
function setCurrentUser(u){ if(u) localStorage.setItem('currentUser', u); else localStorage.removeItem('currentUser'); }

function isMember(me){
  if(!me || !me.memberUntil) return false;
  return Date.now() < me.memberUntil;
}
function remainingDays(me){
  if(!isMember(me)) return 0;
  const ms = me.memberUntil - Date.now();
  const dayMs = 24*60*60*1000;
  return Math.max(0, Math.ceil(ms / dayMs));
}

function renderUserStatus(){
  const cur = getCurrentUser();
  const greeting = document.getElementById('userGreeting');
  const logoutInline = document.getElementById('logoutBtnInline');
  const loginBtn = document.getElementById('loginBtnInline');
  const registerBtn = document.getElementById('registerBtnInline');
  const purchaseBtn = document.getElementById('purchaseBtn');

  if(!cur){
    greeting.textContent = '尚未登入';
    logoutInline.style.display='none';
    loginBtn.style.display='inline-block';
    registerBtn.style.display='inline-block';
    purchaseBtn.style.display='none';
  } else {
    const users = loadUsers();
    const me = users.find(x=>x.username===cur);
    if(me){
      const memberFlag = isMember(me);
      const tail = memberFlag ? `（會員，剩餘 ${remainingDays(me)} 天）` : '（非會員）';
      greeting.textContent = `Hi ${cur} ${tail}`;
      logoutInline.style.display='inline-block';
      loginBtn.style.display='none';
      registerBtn.style.display='none';
      purchaseBtn.style.display = memberFlag ? 'none' : 'inline-block';
    } else {
      greeting.textContent = '尚未登入';
      logoutInline.style.display='none';
      loginBtn.style.display='inline-block';
      registerBtn.style.display='inline-block';
      purchaseBtn.style.display='none';
    }
  }
}

async function register(){
  const u = document.getElementById('registerUser').value.trim();
  const p = document.getElementById('registerPass').value;
  if(!u || !p){ alert('請輸入帳號與密碼'); return; }
  const users = loadUsers();
  if(users.find(x=>x.username===u)){ alert('此帳號已存在'); return; }
  const hash = await sha256Hex(p);
  users.push({ username: u, passwordHash: hash, memberUntil: 0 });
  saveUsers(users);
  setCurrentUser(u);
  closeRegisterModal();
  renderUserStatus();
  alert('註冊完成並已登入');
}

async function login(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u || !p){ alert('請輸入帳號與密碼'); return; }
  const users = loadUsers();
  const user = users.find(x=>x.username===u);
  if(!user){ alert('找不到此帳號'); return; }
  const hash = await sha256Hex(p);
  if(hash !== user.passwordHash){ alert('密碼錯誤'); return; }
  setCurrentUser(u);
  closeLoginModal();
  renderUserStatus();
  alert('登入成功');
}

function logout(){ setCurrentUser(null); renderUserStatus(); alert('已登出'); }

/* ====== 購買方案（序號驗證 + 計算到期） ====== */
function openPurchaseModal(){ document.getElementById('purchaseModal').style.display='flex'; }
function closePurchaseModal(){ document.getElementById('purchaseModal').style.display='none'; }

// 可用序號（可多組擇一）
const SERIALS = {
  month:  { codes:['30ian','30abc','30pro'], days:30   }, // 月繳 100 元
  quarter:{ codes:['90ian','90gold'],        days:90   }, // 季繳 250 元
  year:   { codes:['365ian','365vip'],       days:365  }  // 年繳 800 元
};

function applySerial(){
  const plan = document.getElementById('purchasePlan').value; // month/quarter/year
  const serial = document.getElementById('serialInput').value.trim();
  const cfg = SERIALS[plan];
  if(!serial){ alert('請輸入序號'); return; }
  if(!cfg){ alert('方案有誤'); return; }

  if(cfg.codes.includes(serial)){
    const cur = getCurrentUser();
    if(!cur){ alert('請先登入'); return; }
    const users = loadUsers();
    const me = users.find(x=>x.username===cur);
    if(!me){ alert('找不到使用者資料'); return; }

    const now = Date.now();
    const addMs = cfg.days * 24 * 60 * 60 * 1000;
    // 若原本尚未到期，往後順延；若已到期，從現在重新計算
    const base = (me.memberUntil && me.memberUntil > now) ? me.memberUntil : now;
    me.memberUntil = base + addMs;

    saveUsers(users);
    renderUserStatus();
    closePurchaseModal();
    alert(`升級成功！本次方案 ${cfg.days} 天。剩餘 ${remainingDays(me)} 天。`);
  }else{
    alert('序號無效或不符合方案，請確認後重新輸入。');
  }
}

/* ================== Lottery logic ================== */
let spinning = false;
let winnerLog = [];

function updateDisplay(name, color){
  const display = document.getElementById("currentName");
  if(!name){
    display.textContent = "尚未抽獎";
    display.style.fontSize="80px"; display.style.color="#888"; display.style.animation="";
    return;
  }
  display.textContent = name;
  display.style.fontSize="200px";
  if(color){ display.style.color=color; display.style.animation="flashRed 0.6s 3"; }
  else{ display.style.color="#888"; display.style.animation=""; }
}

function addHistoryRecord(name){
  const prize = document.getElementById("prizeInput").value.trim() || "";
  const now = new Date();
  const record = { name, prize, time: now.toISOString() };
  winnerLog.unshift(record);
  renderHistory();
}

function renderHistory(){
  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML = '';
  if(winnerLog.length === 0){
    historyDiv.innerText = '得獎紀錄會顯示在此。';
    return;
  }
  winnerLog.forEach((r)=>{
    const entry = document.createElement('div');
    const timeLocal = new Date(r.time).toLocaleString();
    entry.textContent = `${r.name} — ${r.prize ? r.prize + ' — ' : ''}${timeLocal}`;
    historyDiv.appendChild(entry);
  });
}
function clearHistory(){ winnerLog = []; renderHistory(); }

async function startDraw(){
  if(spinning) return;
  let names = document.getElementById("names").value.trim().split("\n").map(s=>s.trim()).filter(n=>n);
  if(names.length===0){ alert("請輸入參加者名單！"); return; }
  const winnerNum = parseInt(document.getElementById("winnerCount").value) || 1;
  spinning=true;

  for(let i=0;i<winnerNum;i++){
    if(names.length===0) break;
    let displayNames = names.slice();
    let intervalTime = 50, slowDown=1.05;
    const totalTime = 3000 + Math.random()*2000;
    const startTime = Date.now();

    await new Promise(resolve=>{
      function roll(){
        const currentIndex=Math.floor(Math.random()*displayNames.length);
        updateDisplay(displayNames[currentIndex]);
        intervalTime*=slowDown;
        if(Date.now()-startTime<totalTime){ setTimeout(roll, intervalTime); }
        else{
          let specified = JSON.parse(localStorage.getItem("specifiedList")||"[]")
                            .filter(x=>names.includes(x));
          let winner;
          if(specified.length>0){
            winner = specified[Math.floor(Math.random()*specified.length)];
          } else {
            winner = names[Math.floor(Math.random()*names.length)];
          }
          names = names.filter(n=>n!==winner);
          document.getElementById("names").value = names.join("\n");

          let stored = JSON.parse(localStorage.getItem("specifiedList")||"[]");
          if(stored.includes(winner)){
            stored = stored.filter(n=>n!==winner);
            localStorage.setItem("specifiedList", JSON.stringify(stored));
          }

          addHistoryRecord(winner);
          updateDisplay(winner, "red");
          resolve();
        }
      }
      roll();
    });

    await new Promise(r=>setTimeout(r, 1000));
  }
  spinning=false;
}

/* CSV 與其他工具 */
function uploadCSV(){ document.getElementById("csvFile").click(); }
document.getElementById("csvFile").addEventListener("change",function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const lines = ev.target.result.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="");
    const parsed = lines.map(l => {
      const cols = l.split(",");
      return cols[0].replace(/^"|"$/g,'').trim();
    }).filter(x=>x);
    document.getElementById("names").value = parsed.join("\n");
  };
  reader.readAsText(file);
});
function loadSample(){ document.getElementById("names").value="張三\n李四\n王五\n小明\n小美"; updateDisplay(""); }
function clearList(){ document.getElementById("names").value=""; updateDisplay(""); }
function generateNumberList(){
  const start=parseInt(document.getElementById("startNumber").value);
  const end=parseInt(document.getElementById("endNumber").value);
  if(isNaN(start)||isNaN(end)||start>end){ alert("請輸入正確的數字範圍！"); return; }
  const numbers=[]; for(let i=start;i<=end;i++){ numbers.push(i.toString()); }
  document.getElementById("names").value=numbers.join("\n");
  updateDisplay("");
}
function exportWinners(){
  if(winnerLog.length === 0){ alert("沒有中獎紀錄可匯出"); return; }
  const rows = [['名字','獎品','時間']];
  winnerLog.forEach(r=> rows.push([r.name, r.prize, r.time]));
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "winners.csv";
  a.click();
}

/* 會員限定的「其他」入口 */
function handleOther(){
  const cur=getCurrentUser();
  if(!cur){ alert("此功能為會員功能，請先登入並購買方案。"); return; }
  const users=loadUsers();
  const me=users.find(x=>x.username===cur);
  if(!isMember(me)){
    if(confirm("您的帳號尚非會員或已到期。是否前往「購買方案」輸入序號升級？")){
      openPurchaseModal();
    }
    return;
  }
  openSettingsModal();
}

/* Settings Modal 控制 */
function openSettingsModal(){
  const modal=document.getElementById("settingsModal");
  const textarea=document.getElementById("specifiedList");
  const stored=JSON.parse(localStorage.getItem("specifiedList")||"[]");
  textarea.value=stored.join("\n");
  modal.style.display='flex';
  setTimeout(()=>textarea.focus(),100);
}
function closeSettingsModal(){ document.getElementById("settingsModal").style.display='none'; }
function saveSpecifiedList(){
  const textarea=document.getElementById("specifiedList");
  const list=textarea.value.split(/\r?\n/).map(s=>s.trim()).filter(s=>s);
  localStorage.setItem("specifiedList", JSON.stringify(list));
  alert('已儲存指定名單（本機）');
  closeSettingsModal();
}

/* Modals 開關 */
function openLoginModal(){ document.getElementById('loginModal').style.display='flex'; }
function closeLoginModal(){ document.getElementById('loginModal').style.display='none'; }
function openRegisterModal(){ document.getElementById('registerModal').style.display='flex'; }
function closeRegisterModal(){ document.getElementById('registerModal').style.display='none'; }

/* 初始化 */
(function init(){
  renderUserStatus();
  updateDisplay("");
  renderHistory();
  // 點 backdrop 關閉
  document.querySelectorAll('.modal-backdrop').forEach(m=>{
    m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none'; });
  });
})();
</script>

</body>
</html>